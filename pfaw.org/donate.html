{% extends "./wrapper.html" %}
{% load actionkit_tags %}

{# remove menu on donation pages #}
{% block navigation %}{% endblock %}

{% block css_additions %}

    {% if page.custom_fields.nudge %}
    <link href="//fonts.googleapis.com/css?family=Architects+Daughter" rel="stylesheet" type="text/css">
    {% endif %}

    {% if page.custom_fields.social_share_fb_url and page.custom_fields.social_share_tw_text %}
    <style type="text/css">
        #stayInformed {
            transition: opacity .5s;
            width: 100%;
        }
        .share-social-row .content {
            font-size: 14px;
            min-height: 80px;
            text-align: center;
        }
        .share-social-row .share-link {
            font-size: 14px;
            min-height: 80px;
        }
        .share-social-row .share-link:first-child img {
            margin: 6px 4px 0 0;
        }
        .share-social-row .share-link:last-child img {
            margin: 6px 0 0 4px;
        }
        .donation-form, .donation-content, .share-social-row {
            overflow: hidden;
            box-sizing: border-box;
        }
        .donation-form {
            float: right;
        }
        .share-social-row {
            width: 45%;
            float: left;
            padding-left: 2em;
            max-width: 550px;
        }

        @media screen and (max-width: 800px) {
            .donation-form {
                float: none;
            }
            .share-social-row {
                width: 100%;
                margin:20px auto;
                display: block;
                float: none;
                padding: 0;
            }
        }
    </style>
    {% endif %}

    {% if page.custom_fields.lightbox == "1" %}
    <style>
        .lightbox_desktop, .lightbox_desktop *
        {
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
        }
        .lightbox_desktop
        {
                position: relative;
                background-color: #fff;
                background-image: url(https://s3.amazonaws.com/s3.pfaw.org/images/lightbox/liberty-medium-2015.jpg);
                background-repeat: no-repeat;
                background-position: 0 72px;
                width: 678px;
                height: 510px;
                border: 7px solid #fff;
                font-family: Helvetica, Arial, sans-serif;
                margin: 2% auto;
        }
        .lightbox_desktop button
        {
                margin-top: 16px;
                color: #fff;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.9);
                border: 0;
                text-shadow: 0 0 6px rgba(0, 0, 0, 1);
                display: inline-block;
                vertical-align: top;
                padding: 10px 9px 10px 9px;
                font-family: "Arial Black", Helvetica, Arial, sans-serif;
                font-size: 18px !important;
                line-height: 22px !important;
                font-weight: bold;
                cursor: pointer;
                width: 254px;
                bottom: 14px;
                background: #c1272d; /* Old browsers */
                background: -moz-linear-gradient(top,  #c1272d 0%, #ed1c24 100%); /* FF3.6+ */
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#c1272d), color-stop(100%,#ed1c24)); /* Chrome,Safari4+ */
                background: -webkit-linear-gradient(top,  #c1272d 0%,#ed1c24 100%); /* Chrome10+,Safari5.1+ */
                background: -o-linear-gradient(top,  #c1272d 0%,#ed1c24 100%); /* Opera 11.10+ */
                background: -ms-linear-gradient(top,  #c1272d 0%,#ed1c24 100%); /* IE10+ */
                background: linear-gradient(to bottom,  #c1272d 0%,#ed1c24 100%); /* W3C */
                filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#c1272d', endColorstr='#ed1c24',GradientType=0 ); /* IE6-9 */
                
        }
        .lightbox_desktop button p, .lightbox_desktop button p span
        {
                font-family: "Arial Black", Helvetica, Arial, sans-serif;
                font-size: 22px !important;
                line-height: 25px !important;
                font-weight: bold;
        }
        .lightbox_desktop button p
        {
                width: 234px;
        }
        .orig { float: left; margin-left: 10px; }
        .recurring { float: right; margin-right: 10px; }
        #onetime_override, #onetime_override_mobile {
                color: #0000FF;
                text-decoration: underline;
                text-align: center;
                cursor: pointer;
                display: none;
        }
        #onetime_override {
                color: #FFFFFF;
                position: absolute;
                left: 180px;
                bottom: 0;
        }
        .yes
        {
                font-size: 22px;
                font-weight: bold;
        }
        .lightbox_desktop button p
        {
                border: 1px solid #fff;
                border-radius: 10px;
        }
        .ty
        {
                height: 72px;
                text-indent: -9999999px;
                background: url(https://s3.amazonaws.com/s3.pfaw.org/images/lightbox/title-monthly-2015.png) no-repeat 0px 0px;
        }
        .orig p
        {
                box-shadow: 0 2px 10px rgba(0, 0, 0, .5);
                padding: 5px;
        }
        .recurring p
        {
                box-shadow: 0 2px 10px rgba(0, 0, 0, .5);
                padding: 5px 4px 5px 4px;
        }
        .lightbox_desktop p
        {
                margin: 0;
                color: #fff;
        }
        .body
        {
                font-size: 16px;
                line-height: 22px;
                width: 65%;
                padding-top: 10px;
                padding-left: 14px;
                text-align: left;
        }
        p.large
        {
                padding-top: 15px;
                font-size: 24px;
                line-height: 30px;
                text-shadow: 2px 2px 10px rgba(0, 0, 0, 1), 2px 2px 10px rgba(0, 0, 0, 1);
        }
        p.large span
        {
                font-size: 27px;
                letter-spacing: 0px;
        }
        p.lbp3
        {
                font-size: 21px;
                line-height: 25px;
                text-shadow: 2px 2px 10px rgba(0, 0, 0, 1), 2px 2px 10px rgba(0, 0, 0, 1);
                margin: 0.5em 0;
        }
        .body span
        {
                font-size: 29px;
                letter-spacing: 1px;
        }

        /* Mobile Lightbox */
        .lightbox_mobile { 
                display: none;
                width: 90%;
                margin: 50px auto 0;
                background: #FFF;
                padding-bottom: 10px;
        }

        .lightbox_mobile .thank-you .header {
                float: left;
                height: 76px;
                width: 140px;
                text-indent: -9999999px;
                background-size: cover !important;
                background: url(https://s3.amazonaws.com/s3.pfaw.org/images/lightbox/logo.png) no-repeat 0px 0px;
        }

        .lightbox_mobile .thank-you .banner {
                height: 76px;
                width: 100%;
                text-indent: -9999999px;
                background: url(https://s3.amazonaws.com/s3.pfaw.org/images/lightbox/banner.png) repeat 0px 0px;
        }

        .lightbox_mobile p, .lightbox_mobile h1 {
                color: #2e486a;
                font-size: 24px;
                padding-left: 30px;
                padding-right: 30px;
                text-align: left;
        }

        .lightbox_mobile p {
                font-size: 14px;
        }

        .lightbox_mobile h1 {
                font-size: 20px;
        }

        .lightbox_mobile button {
                width: 90%;
                font-weight: bold;
                display: block;
                margin: 10px auto;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-size: 14px;
                background: #cd1f29; /* Old browsers */
                background: -moz-linear-gradient(top,  #cd1f29 0%, #a5121b 100%); /* FF3.6+ */
                background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#c1272d), color-stop(100%,#a5121b)); /* Chrome,Safari4+ */
                background: -webkit-linear-gradient(top,  #cd1f29 0%,#a5121b 100%); /* Chrome10+,Safari5.1+ */
                background: -o-linear-gradient(top,  #cd1f29 0%,#a5121b 100%); /* Opera 11.10+ */
                background: -ms-linear-gradient(top,  #cd1f29 0%,#a5121b 100%); /* IE10+ */
                background: linear-gradient(to bottom,  #cd1f29 0%,#a5121b 100%); /* W3C */
                filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#cd1f29', endColorstr='#a5121b',GradientType=0 ); /* IE6-9 */
        }

        .lightbox_mobile button br {
                display: none;
        }

        .lightbox_mobile button p {
                color: #FFF;
                padding-left: 10px;
                padding-right: 10px;
                text-align: center;
        }

        .lightbox_mobile > .close,
        .lightbox_desktop > .close {
                top: -20px;
                width: 40px;
                right: 13px;
                height: 40px;
                position: absolute;
                background: url(https://s3.amazonaws.com/s3.pfaw.org/images/lightbox/x.png) no-repeat 0px 0px;
                background-size: contain;
                cursor: pointer;
        }
        .lightbox_desktop > .close {
            right: -20px;
        }

        @media screen and (max-width: 680px) {
                .lightbox_desktop {display: none;}
                .lightbox_mobile {display: block;}
        }


        /* For Annual Membership form (need to override existing CSS) */
        .onetimelink p.lbp2
        {
                line-height: 30px !important;
        }
        .onetimelink p.lbp3
        {
                margin-bottom: 0px !important;
        }
        .onetimelink .lightbox_desktop button
        {
                bottom: 42px !important;
        }
        .onetimelink .lightbox_desktop p.lbottextlink
        {
                margin-top: 0px !important;
                position: absolute;
                bottom: 15px;
                left: 0;
                right: 0;
                text-align: center;
        }
        .onetimelink p.lbottextlink, p.lbottextlink a, p.lbottextlink a:hover
        {
                color: #fff !important;
                text-decoration: underline !important;
        }
        .onetimelink p.lbottextlink a, p.lbottextlink a:hover
        {
                cursor: pointer;
        }
    </style>
    {% endif %}
{% endblock %}

{% block content %}

<div class="donation-content">
    <h1 class="section-title">{{ page.title }}</h1>
    {% include_tmpl form.ask_text %}
</div>

<div class="mobile-payment-options">
  We accept: <img src="https://www.paypalobjects.com/webstatic/en_US/i/buttons/PP_logo_h_100x26.png" alt="PayPal" class="paypal" /> <img src="https://s3.amazonaws.com/s3.pfaw.org/images/visa.png" alt="Visa" /> <img src="https://s3.amazonaws.com/s3.pfaw.org/images/mastercard.png" alt="Mastercard" /> <img src="https://s3.amazonaws.com/s3.pfaw.org/images/amex.png" alt="American Express" /> <img src="https://s3.amazonaws.com/s3.pfaw.org/images/discover.png" alt="Discover" />
</div>

<div class="donation-form">

    <article class="js--multistep-form multistep-form">

        <form id="act" name="act"
            class="{{ templateset.custom_fields.donation_steps }} {% if page.custom_fields.nudge == "1" %}multistep-form--nudge{% endif %} {% if page.custom_fields.nudge == "2" %}multistep-form--monthly-nudge{% endif %}" method="POST" action="/act/" accept-charset="utf-8">
            <input type="hidden" name="page" value="{{ page.name }}">
            <input type="hidden" name="orig_akid" value="{{ akid }}">
            <input id="action_lightbox_sustainer_join" name="action_lightbox_sustainer_join" type="hidden" value="">

            <!--Add .ak-donate-three-step for three-step-->


            <nav class="ak-donate-menu ak-donate-three-step-visible multistep-nav">
                <ul>
                    <li>
                        <label class="ak-donate-step ak-donate-step-1 multistep-nav-item">
                            <input type="radio" id="ak-donate-step-1" name="ak-donate-step" value="1" checked="checked">
                            <span class="ak-step-number">1</span>
                            Amount
                        </label>
                    </li>
                    <li>
                        <label class="ak-donate-step ak-donate-step-2 multistep-nav-item">
                            <input type="radio" id="ak-donate-step-2" name="ak-donate-step" value="2">
                            <span class="ak-step-number">2</span>
                            Name
                        </label>
                    </li>
                    <li>
                        <label class="ak-donate-step ak-donate-step-3 multistep-nav-item">
                            <input type="radio" id="ak-donate-step-3" name="ak-donate-step" value="3">
                            <span class="ak-step-number">3</span>
                            Payment
                        </label>
                    </li>
                </ul>
            </nav>

            <div id="ak-donation-details" class="xak-errs-below">

                <section class="ak-err-above ak-donate-area-step-1 multistep-step">

                    {% with page.custom_fields.monthly_specific_ask_string as monthly_ask_string %}
                    
                    <header>
                        <h1>{{ page.custom_fields.ask_string_headline|default:"Please select your gift amount" }}</h1>
                    </header>

                    <div class="ak-amount-wrapper form-row">
                        <div class="form-content giving-levels">
                            

                            {% if allow_monthly %}
                                {% if monthly_ask_String %}
                                <div class="form-content recurring-options">
                                    <ul>
                                        <li class="recurring-options-option">
                                            <input type="radio" class="recurring-options-option-input js-recurring-options-option-input" name="donation_type" id="id_donation_type_recurring" value="recurring" {% if monthly_ask_string == "1" %} checked {% endif %}>
                                            <label class="recurring-options-option-label" for="id_donation_type_recurring">Monthly</label>
                                        </li>
                                        <li class="recurring-options-option">
                                            <input type="radio" class="recurring-options-option-input js-recurring-options-option-input" name="donation_type" id="id_donation_type_onetime" value="single" {% if monthly_ask_string == "2" %} checked {% endif %}>
                                            <label class="recurring-options-option-label" for="id_donation_type_onetime">One-time</label>
                                        </li>
                                    </ul>
                                </div>
                                {% if page.custom_fields.nudge == "2" %}
                                <p class="js--nudge-content-monthly nudge-content-monthly" id="nudge-content-monthly">A monthly gift goes even further to defend progressive values</p>
                                {% endif %}
                                {% endif %}
                            {% endif %}

                            <ul class="ak-unstyled">
                            {# monthly amounts, if needed #}
                            {% if allow_monthly %}
                            {% if monthly_ask_string %}
                                {% with '10 15 30 50' as monthly_amounts %}
                                    {% for amount in monthly_amounts.split %}
                                        <li class="giving-levels-level giving-levels-level-{{ forloop.counter0 }} js--giving-levels-level--monthly" {% if monthly_ask_string == "2" %} style="display: none;" {% endif %}>
                                            <span class="ak-currency-sym"></span>
                                            <input type="radio" id="id_amount_m_{{amount}}" value="{{ amount }}" class="ak-amount-radio-button" name="amount" {% if monthly_ask_string == "1" and forloop.counter == 2 %} checked {% endif %}>
                                            <label for="id_amount_m_{{amount}}" class="ak-btn">
                                                {{ page.currency_sym }}{{ amount|commify }}
                                            </label>
                                        </li>
                                    {% endfor %}
                                {% endwith %}
                            {% endif %}
                            {% endif %}

                            {# normal amounts #}
                            {% for amount in amounts %}
                                {% if amount == "other" %}
                                <li id="ak-other-amount-container" class="giving-levels-level giving-levels-level--other giving-levels-level-{{ forloop.counter0 }} js--giving-levels-level--other">
                                    <input type="radio" value="" id="amount-other-radio" class="ak-amount-radio-button" name="amount">
                                    <label for="ak-other-amount-field" class="aural-only">Enter amount</label>
                                    <span>{{ page.currency_sym }}</span><input type="text" id="ak-other-amount-field" name="amount_other" class="js--amount-other-input" placeholder="Other">
                                </li>
                                {% else %}
                                <li class="giving-levels-level giving-levels-level-{{ forloop.counter0 }} js--giving-levels-level" {% if monthly_ask_string == "1" %} style="display: none;" {% endif %}>
                                    <span class="ak-currency-sym"></span>
                                    <input type="radio" id="id_amount_{{amount}}" value="{{ amount }}" class="ak-amount-radio-button" name="amount" {% if not args.amount_other and amount == default_amount and monthly_ask_string != "1" %} checked {% endif %}>
                                    <label for="id_amount_{{amount}}" class="ak-btn">
                                        {{ page.currency_sym }}{{ amount|commify }}
                                    </label>
                                </li>
                                {% endif %}
                            {% endfor %}
                            </ul>
                        </div>
                    </div>

                    {% comment %}
                    Recurring functionality can get a bit wild depending on the settings. There are 4 possible options:
                        * Annual checkbox without one-time / monthly buttons above ask string
                        * Annual checkbox *with* one-time / monthly buttons above ask string
                        * Monthly checkbox without one-time / monthly buttons above ask string (otherwise monthly is handled by those buttons)
                        * Forced single donation
                    {% endcomment %}

                    {% if page.custom_fields.annual_checkbox %}
                        {% if not monthly_ask_string %}
                        <!-- BASIC Annual checkbox -->
                        {% else %}
                        <!-- ADVANCED Annual checkbox -->
                        {% endif %}
                    {% elif allow_monthly %}
                        {% if not monthly_ask_strgin %}
                        <!-- BASIC monthly checkbox -->
                        {% else %}
                        <!-- No checkbox -->
                        {% endif %}
                    {% else %}
                        <!-- FORCED single -->
                    {% endif %}


                    {% if not has_products %}
                        {% if allow_monthly %}
                            {% if not monthly_ask_string %}
                            <div class="form-row giving-recurring js--giving-recurring">
                                <div class="form-content form-content--checkbox">
                                    <input type='hidden' name='recurring_period' value='monthly'>
                                    <input type="checkbox" name="donation_type" id="donation_type" value="recurring" class="js--recurring-input">
                                    <label for="donation_type">
                                        Yes, automatically repeat this gift every month.
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                        {% else %}
                        <div id="ak-recurring-type"></div>
                        <input type="hidden" name="donation_type" value="single">
                        {% endif %}
                    {% endif %}
                {% endwith %}
                </section>
                        
                <section id="ak-donation-contact" class="ak-styled-fields ak-donate-area-step-2 ak-errs-below ak-margin-top-1 multistep-step">
                    <ul id="ak-errors"></ul>
                    <div style="display: none"><div id="known_user">
                        Not <span id="known_user_name"></span>?  <a href="?" onclick="return actionkit.forms.logOut()">Click here.</a>
                    </div></div>
                    <div id="unknown_user"></div>

                    <header>
                        <h1>Billing Address</h1>
                    </header>

                    <div class="ak-errs-below test2">

                        <div class="form-row">
                            <div class="form-content">
                                <input type="hidden" name="required" value="name">
                                <label for="id_name">Name: <span class="required">*</span></label>
                                <input type="text" id="id_name" name="name" required />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-content form-content-multi">
                                <label for="id_address1">Address: <span class="required">*</span></label>
                                <input type="text" class="form-field-three-quarter" name="address1" id="id_address1" required />
                                <input type="text" name="address2" class="form-field-quarter" id="id_address2" placeholder="Apt., Fl. #" />
                                <input type="hidden" name="required" value="address1">
                                {% if has_shippable_products %}{# ZZZ #}{% endif %}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-content form-content-third">
                                <input type="hidden" name="required" value="city">
                                <label for="id_city">City: <span class="required">*</span></label>
                                <input type="text" name="city" id="id_city" required />
                            </div>
                            <div class="form-content form-content-third">
                                <input type="hidden" name="required" value="state">
                                <label for="id_state">State: <span class="required">*</span></label>
                                {% include "./state_select.html" %}
                            </div>
                            <div class="form-content form-content-third">
                                <input type="hidden" name="required" value="zip">
                                <label for="id_zip">Zip: <span class="required">*</span></label>
                                <input id="id_zip" type="text" name="zip" maxlength="5" size="5">
                            </div>
                            {% if page.allow_international %}{# ZZZ #}{% endif %}
                        </div>
                        <div class="form-row">
                            <div class="form-content form-content">
                                <input type="hidden" name="required" value="email">
                                <label for="id_email">Email: <span class="required">*</span></label>
                                <input type="email" name="email" id="id_email" required />
                            </div>
                        </div>
                    
                        {% if has_candidates %}{# ZZZ #}{% endif %}

                    </div>
                </section>

                <section class="ak-labels-above ak-styled-fields ak-donate-area-step-3 ak-errs-below multistep-step">

                    <header>
                        <h1>Payment Information</h1>
                    </header>

                    <div class="form-row">
                        <div class="form-content form-content--credit-card">
                            <label for="ak-card_num">Credit Card Number: <span class="required">*</span></label>
                            <input type="hidden" name="required" value="card_num" id="ak-card_num-required">
                            <div id="ak-card_num-hosted" class="hosted-field"></div>
                            <input id="ak-card_num" type="text" name="card_num" required>
                        </div>
                    </div>

                    <div class="form-row ak-err-below">
                        <div class="form-content form-content-half form-content-multi">
                            <label for="ak-exp_date_month">Expiration Date: <span class="required">*</span></label>
                            <input type="hidden" name="required" value="exp_date_month" id="ak-exp_date_month-required">
                            <select id="ak-exp_date_month" type="text" name="exp_date_month">
                                <option value="">MM</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <input type="hidden" name="required" value="exp_date_year" id="ak-exp_date_year-required">
                            <select id="ak-exp_date_year" type="text" name="exp_date_year">
                                <option value="">YYYY</option>
                                {% for year in exp_years %}
                                <option value="{{ year.two }}">{{ year.four }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-content form-content-half form-content-multi">
                            <label for="ak-card_code">CVV Number: <span class="required">*</span> <span class="help"><a href="http://help.convio.net/site/PageServer?s_site=pfaw&amp;pagename=user_donation_cvv" class="HelpLink" tabindex="100"></a></span></label>
                            <input type="text" name="card_code" id="ak-card_code" required="" class="form-field-half">
                            <input type="hidden" name="required" value="card_code" id="ak-card_code-required">
                        </div>
                    </div>

                    <nav class="multistep-controls">
                        {% if page.payment_processor_information.init_submit_disabled %}

                        {% comment %}
                        For pages that use Braintree, the submit button will be enabled by javascript.
                        {% endcomment %}

                        <button disabled="true" type="submit" class="ak-submit-button ak-donate-area-step-3">Donate Now</button>
                        <noscript>
                            <p>
                                <b>JavaScript is required</b> so this page
                                can securely submit your donation.
                            </p>
                        </noscript>

                        {% else %}
                        <button type="submit" class="ak-submit-button ak-donate-area-step-3">Donate Now</button>
                        <a href="#" data-step="2" class="js--multistep-back multistep-back ak-donate-area-step-3">← Back</a>
                        {% endif %}
                    </nav>
                    {% with page.custom_fields.designation as designation %}
                        <p class="disclaimer">PFAW will send you periodic updates by email.</p>
                        <p class="disclaimer">
                            {% if not designation or designation == 'c4' %}
                                Because we lobby Congress, donations to People For the American Way, a nonprofit 501(c)(4) organization, are not tax deductible.
                            {% elif designation == 'c3' %}
                                Donations to People For the American Way Foundation, a nonprofit 501(c)(3) organization, are tax deductible.
                            {% endif %}
                        </p>

                        {% if designation == 'PAC' %}
                            <p class="disclaimer">Contribution Rules:</p>
                            <ul class="disclaimer">
                                <li>This contribution is made from my own funds, and funds are not being provided to me by another person or entity for the purpose of making this contribution.</li>
                                <li>I am making this contribution with my own personal credit card or payment account and not with a corporate or business credit card or a card issued to another person.</li>
                                <li>I am not a federal contractor.</li>
                                <li>I am at least eighteen years old.</li>
                                <li>I am a U.S. citizen or lawfully admitted permanent resident (i.e., green card holder).</li>
                                <li>I affirm that this contribution is not made from the general treasury funds of a corporation, labor organization, or national bank.</li>
                            </ul>
                            <p class="disclaimer">Contributions to PFAW&#8217;s Voters Alliance PAC are not tax deductible and are subject to a $5,000 per calendar year limit.</p>
                            <p class="disclaimer">Federal law requires us to use our best efforts to collect and report the name, mailing address, occupation and name of employer of individuals whose contributions exceed $200 in a calendar year.</p>
                        {% elif designation == '527' %}
                            <p class="disclaimer">Contribution Rules:</p>
                            <ul class="disclaimer">
                                <li>This contribution is made from my own funds, and funds are not being provided to me by another person or entity for the purpose of making this contribution.</li>
                                <li>I am making this contribution with my own personal credit card or payment account and not with a corporate or business credit card or a card issued to another person.</li>
                                <li>I am at least eighteen years old.</li>
                                <li>I am a U.S. citizen or lawfully admitted permanent resident (i.e., green card holder).</li>
                                <li>I affirm that this contribution is not made from the general treasury funds of a corporation, labor organization, or national bank.</li>
                            </ul>
                            <p class="disclaimer">Contributions to PFAW&#8217;s Action Fund are not tax deductible.</p>
                            <p class="disclaimer">State laws require us to use our best efforts to collect and report the name and mailing address of individuals who contribute to the fund.</p>
                        {% endif %}
                    {% endwith %}
                </section>

                <nav class="multistep-controls">
                    <button class="ak-donate-three-step-visible" type="button" id="ak-continue-button">Continue</button>
                    <a href="#" data-step="1" class="js--multistep-back multistep-back ak-donate-area-step-2">← Back</a>
                    {% if show_paypal %}
                        <div class="ak-payment-options ak-margin-bottom-1 ak-donate-area-step-2">
                            <input type="hidden" name="paypal" value="0" id="ak-pay-by-paypal">
                            <span>Or check out with</span>
                            <button type="submit" id="ak-paypal-button" class="ak-inline ak-paypal-button"><img src="/media/modern/paypal-logo-1.svg"></button>
                        </div>
                    {% endif %}
                </nav>

            </div>

        </form>

    </article>

</div>

{% if page.custom_fields.social_share_fb_url and page.custom_fields.social_share_tw_text %}
<div class="share-social-row">
    <div id="stayInformed">
        <span align="center"><h3>Share it!</h3></span>
        <div class="content">
            <div>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ page.custom_fields.social_share_intro|urlencode }}" target="_blank" class="share-link" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
                    <img src="//secure3.convio.net/pfaw/images/content/pagebuilder/pfaw_df_sidebar_fb.png" width="55" height="55" border="0" alt="Share on Facebook">
                </a>
                <a href="https://twitter.com/share?text={{ page.custom_fields.social_share_tw_text|urlencode }}&url=false" target="_blank" class="share-link" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;">
                    <img src="//secure3.convio.net/pfaw/images/content/pagebuilder/pfaw_df_sidebar_tw.png" width="55" height="55" border="0" alt="Share on Twitter">
                </a>
            </div>
            {{ page.custom_fields.social_share_intro }}
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block below_form %}
{{ block.super }}

{% if page.custom_fields.lightbox == "1" %}
<div id="lightbox_23msf90" style="display: none;">
        <div class="lightbox_desktop">
                <div class="close" id="close_desktop"></div>
                <p class="ty lbp1">Make your support monthly?</p>
                <p class="body large lbp2">Maximize your impact &ndash; if you convert your contribution to a monthly gift now, it will be <strong>MATCHED</strong> for the first three months!</p>
                <p class="body lbp3">Your monthly commitment as a Defender of Democracy will help give People For the American Way the steady resources we need to expose the Right's lies and stop their attacks on our freedoms.</p>
                <button id="orig" class="orig"></button>
                <button id="recurring" class="recurring"><p>Convert my<br>donation to a $<span id="amountR">XX</span> monthly gift</p></button>
                <a id="onetime_override" class="onetime_override">Process my gift as a one-time donation instead &gt;&gt;</a>
        </div>
        <div class="lightbox_mobile">
                <div class="close" id="close_mobile"></div>
                <div class="thank-you">
                        <div class="header"></div>
                        <div class="banner"></div>
                </div>
                <h1>Make your support monthly?</h1>
                <p>Maximize your impact &ndash; if you convert your contribution to a monthly gift now, it will be <strong>MATCHED</strong> for the first three months!</p>
                <button id="recurring_mobile" class="recurring_mobile"><p>Convert my donation to<br style="display:block"/>a $<span id="amountR_mobile">XX</span> monthly gift</p></button>
                <button id="orig_mobile" class="orig_mobile"></button>
                <a id="onetime_override_mobile" class="onetime_override_mobile">Process my gift as a one-time donation instead &gt;&gt;</a>
        </div>
</div>
{% include "./mr.js.html" %}
<script>
window.upsellSwitch = true;
</script>
<script>
    (function( window ) {

        var lightbox = { amount: {} },
            calculateUpsellRecurring,
            show;

        calculateUpsellRecurring = function( amount ) {
            if ( amount < 5 ) {
                return false;
            } else if ( amount >= 5 && amount < 7 ) {
                return 5;
            } else if ( amount >= 7 && amount < 9 ) {
                return 7;
            } else if ( amount >= 9 && amount < 50 ){
                return 9;
            } else if ( amount >= 50 && amount < 75 ){
                return 15;
            } else if ( amount >= 75 && amount < 100 ){
                return 19;
            } else if ( amount >= 100 && amount < 150 ){
                return 24;
            } else if ( amount >= 150 && amount < 200 ){
                return 30;
            } else if ( amount >= 200 && amount < 250 ){
                return 36;
            } else {
                return false;
            }
        };
            
        show = function( $form, event) {

            var lightbox = lightbox || { amount: {} };

            //  Get upsell values
            lightbox.amount.original = window.update_total();
            lightbox.amount.onetime = Math.floor( lightbox.amount.original );
            lightbox.amount.recurring = calculateUpsellRecurring( lightbox.amount.onetime );

            //  Gift is outside our range for upsells, process the donation
            if( !lightbox.amount.recurring ) return true;

            //
            //  Gift is within our range, set up lightbox
            //

            //  If we don't already have the lightbox html from a previous showing
            if( !lightbox.html ) {

                //  Lightbox settings
                lightbox.elementId = 'lightbox_23msf90';
                
                //  Check to make sure lightbox HTML exists
                if( !document.getElementById( lightbox.elementId ) ) return true;

                //  Lightbox exists, grab HTML and continue set up
                lightbox.html = document.getElementById( lightbox.elementId ).innerHTML;
                lightbox.width = 678;
                lightbox.height = 591;

                //  Kill placeholder lightbox, to keep jQuery working and save lightbox to Multistep class
                $( '#' + lightbox.elementId ).remove();
            }

            //  Show lightbox
            lightbox.self = new mr.Lightbox();
            lightbox.self.Show( lightbox.html, lightbox.width, lightbox.height );
            lightbox.triggered = true;
              
            // Correct the width and height on mobile
            if (mr.Browser.isMobile) {
                lightbox.self.backgroundDiv.style.maxHeight = "";
                lightbox.self.backgroundDiv.style.maxWidth = "";

                lightbox.self.popupDiv.style.minHeight = "";
                lightbox.self.popupDiv.style.minWidth = "";

                lightbox.self.contentDiv.style.height = "";
                lightbox.self.contentDiv.style.width = "";
            }

            //  Update ask amounts on buttons
            $( '.lightbox_desktop #orig, #orig_mobile' ).html( '<p>Confirm my <br/> one-time <br/> donation</p>' );
            $( '.lightbox_desktop #amountR, .lightbox_mobile #amountR_mobile' ).text( lightbox.amount.recurring );

            //  Update match amount
            if( lightbox.amount.recurring >= 15 ) {
                $( '.lightbox_desktop #match_amount, .lightbox_mobile #match_amount' ).text( '$50' );
            }

            //  If annual checkbox is checked, add One-time donation link to lightbox
            //  Formatting is set up to mirror what happens in reus_annual_checkbox
            // if( lightbox.annual && $( '.js--recurring-input:checked' ).length ) {

            //     //  Add link
            //     $( '#onetime_override, #onetime_override_mobile' ).show();

            //     //  Add one-time gift functionality to one-time link
            //     $( '#onetime_override, #onetime_override_mobile' ).click( function() {
                  
            //       $( '.js--recurring-input', $form ).prop( 'checked', false ).change();
            //       that.submitApi( $form );
            //       that.settings.lightbox.self.Hide();

            //     });

            //     //  Update text to say "annual"
            //     $( '.lightbox_desktop #orig, #orig_mobile' ).html( '<p>Confirm my <br/> annual <br/> donation</p>' );
            // }

            //  Activate processing before window closes
            window.onbeforeunload = function() {
                window.showUpsell = false;
                $( '#act' ).submit();

                dataLayer.push({ 
                  'ga_event_category': 'Multistep form', 
                  'ga_event_action': 'Lightbox', 
                  'ga_event_label': 'Window Closed', 
                  'ga_event_value': 0, 
                  'event': 'ga_track_event' 
                });
            };

            //  Activate lightbox buttons
            $( '#orig, #close_mobile, #orig_mobile, #close_desktop' ).click( function() {
                $( '#action_lightbox_sustainer_join' ).val( '' ); // do not track sustainer donation from lightbox
                window.showUpsell = false;
                $( '#act' ).submit() //  No need to change form
                lightbox.self.Hide();
            });

            $( '.lightbox_desktop #recurring, .lightbox_mobile #recurring_mobile' ).click( function() {

                //  Update value and check appropraite checkbox
                $( '.js--amount-other-input' ).val( lightbox.amount.recurring ).trigger( 'click' );
                $( '.js-recurring-options-option-input[value="recurring"]' ).prop( 'checked', true );
                $( '#action_lightbox_sustainer_join' ).val( 'true' ); // track sustainer lightbox donation

                //  If annual checkbox is present, change frequency and duration and unset monthly options
                // if( lightbox.annual ) {
                //   $( '.js--sustaining-frequency', $form ).val( 'monthly' );
                //   $( '.js--sustaining-duration', $form ).val( '0' );
                // } else {
                  // $( '.js--recurring-input', $form ).prop( 'checked', true );
                // }
                lightbox.submitted = true;
                
                $( '#act' ).submit();
                lightbox.self.Hide();
              });

            // stop the original form submission event
            return false;

        };

        window.showUpsell = function() {
            console.log( 'show upsell' );
            return show();
        };

    })( window );
    

</script>

{% endif %}

<script language="javascript">

    // M+R script additions
    // —

    // Back button
    (function( window ) {
        $( '.js--multistep-back' ).on( 'click', function( e ) {
            three_step_goto( $( this ).data( 'step' ) );
            return false;
        });
    })( window );

    {% if page.custom_fields.monthly_specific_ask_string == "1" or page.custom_fields.monthly_specific_ask_string == "2" %}
    // Monthly-specific ask string module
    (function( window ) {

        var $monthly_levels = $( '.js--giving-levels-level--monthly' ),
            $monthly_radios = $monthly_levels.find( 'input[type="radio"]'),
            $onetime_levels = $( '.js--giving-levels-level' ).not( $monthly_levels ),
            $onetime_radios = $onetime_levels.find( 'input[type="radio"]'),
            $toggles = $( '.js-recurring-options-option-input' ),
            toggleLevels;

        toggleLevels = function( event ) {

            var $checked = $toggles.filter( ':checked' ),
                $switchingFromRadios = $checked.val() !== 'recurring' ? $monthly_radios : $onetime_radios,
                $switchingToRadios  = $checked.val() === 'recurring' ? $monthly_radios : $onetime_radios,
                checkedIndex;

            // make sure that the visible levels are not the "switching to" levels,
            // and, if not, check the level in the switching to levels that is at
            // the same index as the currently checked level.
            if ( !$switchingToRadios.is( ':visible' ) ) {
                checkedIndex = $switchingFromRadios.index( $switchingFromRadios.filter( ':checked' ) );
                if ( checkedIndex > -1 && $switchingToRadios[checkedIndex] ) {
                    $switchingToRadios[checkedIndex].checked = true;
                }
            }

            // revel correct levels
            $monthly_levels.toggle( $checked.val() === 'recurring' );
            $onetime_levels.toggle( $checked.val() !== 'recurring' );

            // add selected CSS support for older browsers
            $toggles.next( 'label' ).removeClass( 'recurring-options-option--selected' );
            $checked.next( 'label' ).addClass( 'recurring-options-option--selected' );

        }

        $toggles.on( 'change', toggleLevels ).trigger( 'change' );

    })( window );
    {% endif %}

</script>
{% endblock %}

{% block script_additions %}

<script language="javascript">
//<!--
    function clear_radio_buttons() {
        $('input.ak-amount-radio-button').prop('checked', false);
    }

    function clear_other() {
        $('#ak-other-amount-field').val("");
    }

    function product_info(id) {
        var product_element = $("#product_" + id),
            quantity = 0,
            price = parseFloat($("#product_" + id + "_price").data("price"));

        if (product_element.is(':checkbox')) {
            if (product_element.is(':checked')) {
                quantity = 1;
            }
        } else if (product_element.val() != "") {
            quantity = parseInt(product_element.val());
        }

        return {
            'id': id,
            'price': price,
            'quantity': quantity,
            'subtotal': (price * quantity)
        }
    }

    function update_total() {
        var total = 0.0;

        product_infos().forEach(function(info) {
            total += info.subtotal;
        });

        $('.ak_candidate_inputs').each(function (i) {
            // check that amount is a valid amount
            var amount = this.value;
            if (amount.length == 0 || ! /^[0-9]\d*(\.\d\d)?$/.test(amount)) {
                return;
            }

            total += parseFloat(amount);
        });

        // look for checked off donation amounts
        var amount_checked = $('input:radio[name=amount]:checked').val();
        if (amount_checked) {
            total += parseFloat(amount_checked);
        } else {
            // or other amounts
            var other = $('#ak-other-amount-field').val();
            if (typeof other !== "undefined" &&
                other.length && /^\d*(\.\d{1,2})?$/.test(other))
                total += parseFloat(other);
        }

        var new_total = total == 0 ? "" : "" + total.toFixed(2);
        $('.ak-donation-total-amount').html(new_total);
        return total;
    }

    $(function() {
        $('.ak_product_inputs').on('change blur', update_total);
        $('.ak_candidate_inputs').on('change blur', update_total);
        $('.ak-amount-radio-button').on('change blur', update_total)
                                .on('click', clear_other)
                                .on('click', update_total);
        $('#ak-other-amount-field').on('change blur', update_total)
                                .on('click keyup', clear_radio_buttons)
                                .on('click', update_total);
    });

    /* Amount buttons */
    function highlight_selected_amount_button() {
        $('label.ak-radio-checked').removeClass('ak-radio-checked');
        $(this).closest('label').addClass('ak-radio-checked');
    }
    $(function() {
        $('input[name="amount"]').on(
            'click', highlight_selected_amount_button);
        $('input[name="amount_other"]').on(
            'click change', highlight_selected_amount_button);

        // Make sure label is highlighted if an amount is pre-selected
        highlight_selected_amount_button.call(
            $('input[name="amount"]:checked').get(0) //||
            //$('input[name="amount_other"]').get(0)
        );
    });

    /* Currency symbols */
    function redraw_currency_symbol() {
        var id = $('input[id^=id_currency_]:checked').attr('id');
        var iso_code_match = /([A-Z][A-Z][A-Z])$/.exec(id);
        if ( ! iso_code_match ) {
            return
        }
        var iso_code = iso_code_match[1];
        var currency_sym = actionkit.utils.currencySymbols[iso_code];
        $('.ak-currency-sym').text( currency_sym || '' );
    }

    $(function() {
        $('input[id^=id_currency_]').on('change', redraw_currency_symbol);
        redraw_currency_symbol();
    });


    var address_fields = [
        'address1', 'address2', 'city', 'state', 'zip'
        {% if page.allow_international %}, 'postal', 'region', 'country'{% endif %}
    ];

    {% if page.allow_international %}
    function country_change() {
        if ( $('#id_country').val() == 'United States' ) {
            $('.ak-us-billing-fields').show();
            $('.ak-intl-billing-fields').hide();
        } else {
            $('.ak-us-billing-fields').hide();
            $('.ak-intl-billing-fields').show();
        }
        sync_to_shipping();
    }
    function shipping_country_change() {
        if ( $('#shipping_country').val() == 'United States' ) {
            $('.ak-us-shipping-fields').show();
            $('.ak-intl-shipping-fields').hide();
        } else {
            $('.ak-us-shipping-fields').hide();
            $('.ak-intl-shipping-fields').show();
        }
    }
    $( function () {
        $('#id_country').on('change blur', country_change);
        $('#id_shipping_country').on('change blur', shipping_country_change);
        country_change();
        shipping_country_change();
    } );
    {% endif %}


    function toggle_shipping() {
        if ( $('#ak-shipping-same').prop("checked") ) {
            sync_to_shipping();
            $('#ak-shipping-fields').slideUp();
            if($('.ak-shipping-required').length)
                $('.ak-shipping-required').remove();
        } else {
            clear_shipping();
            $('#ak-shipping-fields').slideDown();
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_address1' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_city' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_state' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_zip' class='ak-shipping-required'>");
        }
    }

    function clear_shipping(e) {
        var i, field, ship_field;
        for (i in address_fields) {
            field = address_fields[i];
            ship_field = $('#id_shipping_' + field);
            ship_field.val("").change().prop("readonly", false);
        }
        {% if page.allow_international %}
        shipping_country_change();
        {% endif %}
    }

    function sync_to_shipping(e) {
        if ( ! $('#ak-shipping-same').prop("checked") ) {
            return;
        }
        var i, field, ship_field, bill_value;
        for (i in address_fields) {
            field = address_fields[i];
            ship_field = $('#id_shipping_' + field);
            bill_value = $('#id_' + field).val();
            ship_field.val(bill_value).change().prop("readonly", true);
        }
        {% if page.allow_international %}
        shipping_country_change();
        {% endif %}
    }

    $( function () {
        $('#ak-shipping-same').on('change', toggle_shipping);
        toggle_shipping();

        $('#id_address1, #id_address2, #id_city, #id_state, #id_zip, ' +
            '#id_region, #id_postal').on('change blur', sync_to_shipping);
    } );

    var three_step_initialized = 0;
    function three_step_reveal() {
        var current_step = $('input[name="ak-donate-step"]:checked').val();
        if ( current_step != "2" && current_step != "3" ) {
            current_step = "1"
        }
        var speed = three_step_initialized ? 1 : 400;
        if ( current_step == "1" ) {
            $('.ak-donate-area-step-2, .ak-donate-area-step-3').hide();
            $('.ak-donate-area-step-1, #ak-continue-button').fadeIn( speed );

        } else if ( current_step == "2" ) {
            $('.ak-donate-area-step-1, .ak-donate-area-step-3').hide();
            $('.ak-donate-area-step-2, #ak-continue-button').fadeIn( speed,
                focus_field_if_blank( $('#id_name') )
            );
        } else if ( current_step == "3" ) {
            $('.ak-donate-area-step-1, .ak-donate-area-step-2, #ak-continue-button').hide();
            $('.ak-donate-area-step-3').fadeIn( speed,
                focus_field_if_blank( $('#ak-card_num') )
            );
        }
    }

    function focus_field_if_blank ( field_elt ) {
        return ( function () {
            if ( ! field_elt.val() ) {
                field_elt.focus()
            }
        } )
    }

    var step_has_errors = false;
    function three_step_advance() {
        // trigger validation on the step we're leaving
        var current_step = $('input[name="ak-donate-step"]:checked').val();
        validate_step(current_step);

        if (!step_has_errors) {
            $('input[name="ak-donate-step"]:checked').closest('li').
                next('li').find('input[type="radio"]').prop('checked', true);
            three_step_reveal();
        }
    }

    function three_step_goto(next) {
        // trigger validation on the step we're leaving
        var current_step = $('input[name="ak-donate-step"]:checked').val();

        // skip validation if we're going backwards
        if (current_step < next) {
            validate_step(current_step);
        }

        // can't skip over a step unless it's already been completed
        if ( (! step_has_errors) && (current_step == 1) && (next == 3) ) {
            validate_step(2);
            if ( step_has_errors ) {
                $('#ak-donate-step-2').prop('checked', true);
                three_step_reveal();
                return;
            }
        }

        // allow the user to go back even if there are errors
        if (current_step > next || !step_has_errors) {
            $('#ak-donate-step-' + next).prop('checked', true);
            three_step_reveal();
        }
    }

    function validate_product_count ( field ) {
        var product_count = field.value;
        if (product_count == "" || product_count == "0") {
            return true
        }
        product_count = parseInt( product_count );
        var product_max = parseInt( $(field).attr('max') );
        if ( product_max && product_count > product_max ) {
            var err_msg = actionkit.forms.errorMessage('product:max');
            err_msg = err_msg.replace("{0}", product_max);
            return err_msg
        }
        return true
    }

    // even for recognized users we still need to require all user fields
    actionkit.forms.alwaysRequireUserFields = true;

    /* used to limit AK built-in validation to particular fields by step */
    var doing_step_validation = false;
    var validate_fields = [];
    function validate_step(step) {
        step_has_errors = false;
        if (step == "1") {
            validate_fields = ["amount"];
        } else if (step == "2") {
            validate_fields = ["email", "first_name", "last_name", "name",
                               "address1", "address2", "city", "state", "zip",
                               "country", "region", "postal",
                               "shipping_address1", "shipping_address2",
                               "shipping_city", "shipping_state",
                               "shipping_zip", "shipping_country",
                               "shipping_region", "shipping_postal"
                               {% if has_candidates %},"action_employer", "action_occupation"{% endif %}];
        } else {
            validate_fields = ["card_num", "card_code",
                               "exp_date_year", "exp_date_month", "exp_date"];
        }

        doing_step_validation = true;
        actionkit.forms.validate();
        doing_step_validation = false;

        if (step == "1") {
            step_has_errors = step_1_validation();
        }

        if (step == "2" && !step_has_errors) {
            step_has_errors = step_2_validation();
        }


        if (step == "3" && !step_has_errors) {
            step_has_errors = step_3_validation();
        }
    }

    function do_validate_credit_card() {
        if (actionkit.donations && actionkit.donations.skip_cc_validation) {
            return false;
        }

        return true;
    }

    function step_3_validation() {
        var step_has_errors = false;

        if (!do_validate_credit_card()) {
            return step_has_errors;
        }

        if (!valid_credit_card($('#ak-card_num').val())) {
            if (!actionkit.errors)
                actionkit.errors = {};
            actionkit.errors['card_num:invalid'] = actionkit.forms.errorMessage('card_num:invalid');
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;
        }
        
        if (!valid_credit_card_code($('#ak-card_code').val())) {
            if (!actionkit.errors)
                actionkit.errors = {};
            actionkit.errors['card_code:invalid'] = actionkit.forms.errorMessage('card_code:invalid');
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;
        }

        return step_has_errors;
    }

    function step_2_validation() {
        var step_has_errors = false;
        if (!valid_email($('#id_email').val())) {
            if (!actionkit.errors)
                actionkit.errors = {};
            actionkit.errors['email:invalid'] = actionkit.forms.errorMessage('email:invalid');
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;
        }
        return step_has_errors;
    }  

    function step_1_validation() {
        var step_has_errors = false;

        // look for product selections
        var selected_products = false;
        product_infos().forEach(function(info) {
            if (info.quantity) {
                selected_products = true;
            }
        });

        // look for candidate selections
        var selected_candidates = false;
        $('.ak_candidate_inputs').each(
            function(i) {
                if ($(this).val() != "")
                    selected_candidates = true;
            });
        
        // there's no built-in validation for amounts, so do it here
        if (!selected_products && !selected_candidates &&
            !$('.ak-amount-radio-button').is(':checked') &&
            $('#ak-other-amount-field').val() == "") {
            if (!actionkit.errors)
                actionkit.errors = {};
            actionkit.errors['amount:missing'] = actionkit.forms.errorMessage('amount:missing');
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;
            
        } else if (($('#ak-other-amount-field').val() != "" &&
                    $('#ak-other-amount-field').val() != undefined)  &&
                   !/^\d*(\.\d{1,2})?$/.test($('#ak-other-amount-field').val())) {
            if (!actionkit.errors)
                actionkit.errors = {};
            actionkit.errors['amount:invalid'] = actionkit.forms.errorMessage('amount:invalid');
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;
        }
        
        {% if page.minimum_amount %}
        var total = update_total();
        if (!step_has_errors && total < {{ page.minimum_amount }}) {
            if (!actionkit.errors) {
                actionkit.errors = {};
            }
            err = actionkit.forms.errorMessage('amount:minimum');
            err = err.replace("{0}", "{{ page.minimum_amount }}");
            actionkit.errors['amount:minimum'] = err;
            actionkit.forms.onValidationErrors(actionkit.errors);
            step_has_errors = true;
        }
        {% endif %}

        return step_has_errors;
    }

    function actionkitValidationErrors(errors, field) {
        // only want this running during step validation
        if (!doing_step_validation) {
            return;
        }

        // trim out validation errors we don't care about on this step
        var to_delete = [];
        step_has_errors = false;
        for (var key in errors) {
            parts = key.split(':');
            if (validate_fields.indexOf(parts[0]) == -1) {
                to_delete.push(key);
            } else {
                step_has_errors = true;
            }
        }
        for (var i = 0; i < to_delete.length; i++) {
            delete errors[to_delete[i]];
        }
    }

    function three_step_initialize() {
        if (actionkit.errors) {
            var has_errors = [];
            if ($('.ak-donate-area-step-1').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-1'));
            }
            if ($('.ak-donate-area-step-2').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-2'));
            }
            if ($('.ak-donate-area-step-3').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-3'));
            }

            if (has_errors.length == 1) {
                // just one pane with errors?  show it
                has_errors[0].show();
            } else {
                // otherwise show all steps
                $('.ak-donate-area-step-1, .ak-donate-area-step-2, .ak-donate-area-step-3').show();
                $('#ak-continue-button').hide();
            }
        }
        three_step_initialized = 1;
    }

    $(function() {
         // three-step vs. one-step UI
        if ( $('form.ak-donate-three-step').length == 0 ) {
            $('.ak-donate-three-step-visible').hide();
        } else {
            $('.ak-donate-three-step-hidden').hide();
            three_step_reveal();
            window.actionkitFormReady = three_step_initialize;
            // $('.ak-donate-menu input[type="radio"]').on('change', three_step_reveal);
            $('#ak-continue-button').on('click', function (evt) {
                // letting this event go will trigger our onsubmit and lead to validation woe
                evt.preventDefault();
                three_step_advance();
            });
            $('.ak-donate-step-1').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('1');
            });
            $('.ak-donate-step-2').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('2');
            });
            $('.ak-donate-step-3').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('3');
            });
        }
    });

    function product_ids() {
        return $("[data-product]").map(function(i, el) {
            return $(el).data("product");
        }).toArray();
    }

    function product_infos() {
        return product_ids().map(function(id) {
            return product_info(id);
        });
    }

    // calculate subtotals if products exist
    function calculate_product_subtotals() {
        var subtotal = 0;
        product_infos().forEach(function(info) {
            $('.ak_product_subtotal_' + info.id).text(info.subtotal.toFixed(2));
            subtotal += info.subtotal;
        });
        $('#ak-donation-subtotal-amount').text(subtotal.toFixed(2));
    }

    $(function() {
        calculate_product_subtotals();

        $('.ak_product_inputs').on('change', function() {
            calculate_product_subtotals();
        });
    });

    // Standard luhn check to detect mistyped credit card numbers
    // from https://gist.github.com/DiegoSalazar/4075533
    function valid_credit_card(value) {
        if (/[^0-9-\s]/.test(value)) {
            return false;
        }
        var nCheck = 0, nDigit = 0, bEven = false;
        value = value.replace(/\D/g, "");

        for (var n = value.length - 1; n >= 0; n--) {
            var cDigit = value.charAt(n),
            nDigit = parseInt(cDigit, 10);

            if (bEven) {
                if ((nDigit *= 2) > 9) {
                    nDigit -= 9;
                }
            }

            nCheck += nDigit;
            bEven = !bEven;
        }

        return (nCheck % 10) == 0;
    }

    function valid_credit_card_code(value) {
        if (/[^0-9-\s]/.test(value)) {
            return false;
        }
        value = value.replace(/\D/g, "");
        if (value.length == 3 || value.length == 4) {
            return true;
        }
        return false;
    }

    // not 100% the same as Django but pretty close
    var email_regExp = /^\s*((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\s*$/i;
    function valid_email(email) {
        return email_regExp.test(email);
    }

    function submit_paypal() {
        {% if page.paypal_user_requirements != "none" %}
            {% if page.paypal_user_requirements == "email" %}
                validate_fields = ["email"];
            {% else %}
                validate_fields = [
                    "email", "first_name", "last_name", "name",
                    "address1", "address2", "city", "state", "zip",
                    "country", "region", "postal",
                    "shipping_address1", "shipping_address2",
                    "shipping_city", "shipping_state",
                    "shipping_zip", "shipping_country",
                    "shipping_region", "shipping_postal"
                    {% if has_candidates %},"action_employer", "action_occupation"{% endif %}
               ];
           {% endif %}

           doing_step_validation = true;
           actionkit.forms.validate();
           doing_step_validation = false;
           if (!$.isEmptyObject(actionkit.errors)) {
               return false;
           }
        {% endif %}

        /* set the paypal=1 hidden field */
        $('#ak-pay-by-paypal').val(1);

        /* clear out CC info if entered */
        $('#ak-card_num').val('');
        $('#ak-card_code').val('');

        /* disable CC requirements */
        $('#ak-card_num-required').remove();
        $('#ak-card_code-required').remove();
        $('#ak-exp_date_month-required').remove();
        $('#ak-exp_date_year-required').remove();

        /* and keep submitting */
        return true;
    }

    function submit_cc() {
        /* clear paypal=1 hidden field, only needed if someone hit back */
        $('#ak-pay-by-paypal').val(0);

        if ( $('form.ak-donate-three-step').length > 0 ) {
            validate_step("3");

            if (step_has_errors) {
                return false;
            } else {
                // fire upsell lightbox if necessary
                if ( window.upsellSwitch && $( '[name="donation_type"]:checked' ).val() !== 'recurring' ) {
                    return window.showUpsell();
                }
                return true;
            }
        }

        
        /* not doing 3-step, so we need to do all the validation here,
         * don't want to short-circuit and only run one step, better
         * to run all three even if all three have errors */
        actionkit.forms.validate();
        results = [step_1_validation(),
                   step_2_validation(),
                   step_3_validation()];
        return !(results[0] || results[1] || results[2]);
    }

    $( function () {
        $('#ak-paypal-button').on('click', submit_paypal);
    	$('.ak-submit-button').on('click', submit_cc);

        {% if page.paypal_user_requirements == "none" %}
        $('#ak-paypal-button').on('mousedown', function () {
            var form_elt = $(this).closest('form');
            var required_fields = form_elt.find('input[name="required"]');
            if ( required_fields.length ) {
                required_fields.remove();
                $('body').on('mouseup', function ( event ) {
                    form_elt.append( required_fields );
                    $( this ).unbind( event );
                } );
            }
        } );
        {% endif %}
    } );

//-->
</script>

{% with page.payment_processor_information as pp %}
{% if pp.use_vzero %}
<style type="text/css">
.hosted-field {
    height: 2.375em;
    padding: 7px 7px;
    margin-bottom: 6px;
    background-color: white;
    border: 1px solid #ccc;
}
.hosted-field.braintree-hosted-fields-invalid {
    border-color: {{ templateset.custom_fields.color_error|default:"#d00" }};
    background-color: #FFC8C8;
}
</style>
<script src="https://js.braintreegateway.com/web/3.5.0/js/client.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.5.0/js/hosted-fields.min.js"></script>
<script src="https://js.braintreegateway.com/web/3.5.0/js/data-collector.min.js"></script>
<script src="/resources/ak_braintree_vzero.js"></script>
<script>
$(function() {
    var form = document.querySelector("#act"),
        options = {
            form: form,
            fields: {
                number: {
                    selector: '#ak-card_num-hosted'
                },
                cvv: {
                    selector: '#ak-card_code-hosted'
                },
                expirationDate: {
                    selector: '#ak-exp_date-hosted',
                    placeholder: 'MM / YYYY'
                }
            },
            styles: {
                'input': {
                    'font-family': '{{ templateset.custom_fields.font_family|default:"sans-serif"|safe }}',
                    'font-size': '{{ templateset.custom_fields.font_size|default:"16.5px" }}',
                    'color': '#4b4b4b'
                },
                'input.invalid': {
                    'color': '{{templateset.custom_fields.color_error|default:"#d00" }}',
                    'background-color': '#FFC8C8'
                },
                'input.valid': {
                    'color': 'green'
                }
            },
            submitOnEmpty: function() {
                return $('#ak-pay-by-paypal').val() == 1;
            },
            submit: form.querySelector(".ak-submit-button")
        },
        toRemove = ["#ak-card_num", "#ak-card_code", "#ak-exp_date_month",
                    "#ak-exp_date_year", "#ak-card_num-required",
                    "#ak-card_code-required", "#ak-exp_date_month-required",
                    "#ak-exp_date_year-required"];

    toRemove.forEach(function(el) {
        $(el).remove();
    });

    actionkit.donations.handleError = function(err) {
        if (window.console) {
            window.console.log(err);
        }

        if (!actionkit.errors) {
            actionkit.errors = {};
        }

        switch (err.code) {
            case 'HOSTED_FIELDS_FIELDS_EMPTY':
                actionkit.errors['card_num:invalid'] = "Credit card fields are empty.";
                break;
          case 'HOSTED_FIELDS_FIELDS_INVALID':
                err.details.invalidFieldKeys.forEach(function(key) {
                    var map = {
                        'number': 'card_num',
                        'cvv': 'card_code',
                        'expirationDate': 'card_exp'
                    };
                    actionkit.errors[map[key] + ':invalid'] = "This field is invalid.";;
                });
                break;
          case 'HOSTED_FIELDS_FAILED_TOKENIZATION':
                actionkit.errors['card_num:invalid'] = "Please check that your credit card is valid.";
                break;
          case 'HOSTED_FIELDS_TOKENIZATION_NETWORK_ERROR':
                actionkit.errors['card_num:invalid'] = "Network error.";
                break;
          default:
                actionkit.errors['card_num:invalid'] = "An error occurred: " + err.message;
        }
        actionkit.forms.onValidationErrors(actionkit.errors);
    };

    actionkit.donations.initClient('{{ pp.client_token }}', options);

    // read by 3-step validation
    actionkit.donations.skip_cc_validation = true;
    actionkit.donations.vzero = true;
});
</script>
{% endif %}
{% endwith %}

{% endblock %}
